%% -*- mode: erlang;erlang-indent-level: 4;indent-tabs-mode: nil -*-
%% ex: ts=4 sw=4 ft=erlang et

%% Vendoring deps
{project_app_dirs, ["apps/*","lib/*",".","vendor/*"]}.
{project_plugin_dirs, ["plugins/*","vendor_plugins/*"]}.

{project_plugins, [
    {rebar3_ex_doc, "0.2.30"},
    {rebar3_hex, "7.0.11"}
]}.

%% Duplicated from apps/rebar3:
%% - we want people who rely on rebar3 as a dependency to still be able
%%   to fetch it with git_subdir and have it work
{escript_main_app, rebar}.
{escript_name, rebar3}.
{escript_wrappers_windows, ["cmd", "powershell"]}.
{escript_comment, "%%Rebar3 3.25.1\n"}.
{escript_emu_args, "%%! +sbtu +A1\n"}.
%% escript_incl_priv is for internal rebar-private use only.
%% Do not use outside rebar. Config interface is not stable.
{escript_incl_priv, [{relx, "templates/*"},
                     {rebar, "templates/*"}]}.

{overrides, [{add, relx, [{erl_opts, [{d, 'RLX_LOG', rebar_log}]}]}]}.

{profiles, [
    %% Only works at the top-level
    {systest, [
        {erl_opts, [debug_info, nowarn_export_all]},
        {ct_opts, [{dir, "systest"}]}
    ]},
    %% Don't check these vendored deps
    {dialyzer, [
        {erl_opts, [debug_info, nowarn_export_all]},
        %% Ignore deps known to generate warnings
        {dialyzer, [{warnings, [no_unknown]},
                    {plt_extra_apps, [parsetools, public_key]},
                    {exclude_apps, [cth_readable, erlware_commons, relx]}]}
    ]},
    {docs, [
    % ./rebar3 as docs ex_doc --app rebar
        {ex_doc, [
            {source_url, <<"https://github.com/erlang/rebar3">>},
            {extras, [
                <<"README.md">>,
                <<"docs/getting-started.md">>,
                <<"docs/basic_usage.md">>,
                <<"docs/workflow.md">>,
                <<"docs/configuration/configuration.md">>,
                <<"docs/configuration/dependencies.md">>,
                <<"docs/configuration/profiles.md">>,
                <<"docs/configuration/plugins.md">>,
                <<"docs/configuration/config_script.md">>,
                <<"docs/commands.md">>,
                <<"docs/testing/introduction.md">>,
                <<"docs/testing/ct.md">>,
                <<"docs/testing/eunit.md">>,
                <<"docs/testing/coverage.md">>,
                <<"docs/package_management/publishing-packages.md">>,
                <<"docs/deployment/releases.md">>,
                <<"docs/tutorials/building_plugins.md">>,
                <<"docs/tutorials/templates.md">>,
                <<"docs/tutorials/building_c_cpp.md">>,
                <<"docs/tutorials/using_breakpoints_to_debug_tests.md">>,
                <<"docs/tutorials/from_rebar2_to_rebar3.md">>,
                <<"docs/extending/custom_compiler_modules.md">>,
                <<"docs/extending/custom_dep_resources.md">>,
                <<"docs/extending/custom_compiler_plugins.md">>,
                <<"docs/about/about-us.md">>,
                <<"docs/about/security-policy.md">>
            ]},
            {groups_for_extras,[
                % Temporary hack, awaiting official groups_for_extras support in rebar3_ex_doc
                %
                %  1. mkdir _checkouts && cd _checkouts && ln -s ../_build/default/plugins/rebar3_ex_doc rebar3_ex_doc
                %  2. In `to_ex_doc_format/1`, add the following clause:
                %
                %         ({groups_for_extras = K, Groups}, Opts) when is_list(Groups) ->
                %            [{K, [{to_binary(GroupName), L} || {GroupName, L} <- Groups]} | Opts];
                %
                %  3. The current config abuses knowledge of the Regex internals
                {'Configuration', #{source => <<"docs/configuration">>, '__struct__' => 'Elixir.Regex', re_pattern => nil, opts => [], re_version => nil}},
                {'Testing', #{source => <<"docs/testing">>, '__struct__' => 'Elixir.Regex', re_pattern => nil, opts => [], re_version => nil}},
                {'Hex Package Management', #{source => <<"docs/package_management">>, '__struct__' => 'Elixir.Regex', re_pattern => nil, opts => [], re_version => nil}},
                {'Deployment', #{source => <<"docs/deployment">>, '__struct__' => 'Elixir.Regex', re_pattern => nil, opts => [], re_version => nil}},
                {'Tutorials', #{source => <<"docs/tutorials">>, '__struct__' => 'Elixir.Regex', re_pattern => nil, opts => [], re_version => nil}},
                {'Extending Rebar3', #{source => <<"docs/extending">>, '__struct__' => 'Elixir.Regex', re_pattern => nil, opts => [], re_version => nil}},
                {'About', #{source => <<"docs/about">>, '__struct__' => 'Elixir.Regex', re_pattern => nil, opts => [], re_version => nil}}
            ]},
            {main, <<"readme">>}
        ]}
    ]},
    %% Duplicated from apps/rebar3:
    %% - we don't want the test profile applied to our vendored deps.
    %% - we want people who rely on rebar3 as a dependency to still be able
    %%   to fetch it with git_subdir and have it work
    {test, [
        {deps, [{meck, "0.8.13"}]},
        {erl_opts, [debug_info, nowarn_export_all]}
    ]},
    {prod, [
        {erl_opts, [no_debug_info]},
        {overrides, [
            {override, erlware_commons, [
                {erl_opts, [no_debug_info,
                            warnings_as_errors]},
                {deps, []}, {plugins, []}]},
            {add, ssl_verify_hostname, [{erl_opts, [no_debug_info]}]},
            {add, certifi, [{erl_opts, [no_debug_info]}]},
            {add, cf, [{erl_opts, [no_debug_info]}]},
            {add, cth_readable, [{erl_opts, [no_debug_info]}]},
            {add, eunit_formatters, [{erl_opts, [no_debug_info]}]},
            {override, bbmustache, [
                {erl_opts, [no_debug_info, {platform_define, "^[0-9]+", namespaced_types}]},
                {deps, []}, {plugins, []}]},
            {add, getopt, [{erl_opts, [no_debug_info]}]},
            {add, providers, [{erl_opts, [no_debug_info]}]},
            {add, relx, [{erl_opts, [no_debug_info]}]}]}
    ]}
]}.

{compiler_error_format, rich}.
%% The rest of the config is in apps/rebar/
